'use strict';

// Last time updated: 2017-08-11 1:21:20 PM UTC

// _______________
// getStats v1.0.4

// Open-Sourced: https://github.com/muaz-khan/getStats

// --------------------------------------------------
// Muaz Khan     - www.MuazKhan.com
// MIT License   - www.WebRTC-Experiment.com/licence
// --------------------------------------------------

"use strict";window.getStats=function(mediaStreamTrack,callback,interval){function getStatsLooper(){getStatsWrapper(function(results){results.forEach(function(result){Object.keys(getStatsParser).forEach(function(key){"function"==typeof getStatsParser[key]&&getStatsParser[key](result)})});try{peer.iceConnectionState.search(/failed/gi)!==-1&&(nomore=!0)}catch(e){nomore=!0}nomore===!0&&(getStatsResult.datachannel&&(getStatsResult.datachannel.state="close"),getStatsResult.ended=!0),getStatsResult.results=results,callback(getStatsResult),nomore||void 0!=typeof interval&&interval&&setTimeout(getStatsLooper,interval||1e3)})}function getStatsWrapper(cb){"undefined"!=typeof window.InstallTrigger?peer.getStats(mediaStreamTrack,function(res){var items=[];res.forEach(function(r){items.push(r)}),cb(items)},cb):peer.getStats(function(res){var items=[];res.result().forEach(function(res){var item={};res.names().forEach(function(name){item[name]=res.stat(name)}),item.id=res.id,item.type=res.type,item.timestamp=res.timestamp,items.push(item)}),cb(items)})}var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;"undefined"==typeof MediaStreamTrack&&(MediaStreamTrack={});var systemNetworkType=((navigator.connection||{}).type||"unknown").toString().toLowerCase(),getStatsResult={audio:{send:{tracks:[]},recv:{tracks:[]},bytesSent:0,bytesReceived:0},video:{send:{tracks:[]},recv:{tracks:[]},bytesSent:0,bytesReceived:0},results:{},connectionType:{},connectionType:{local:{},remote:{}},resolutions:{send:{},recv:{}},internal:{audio:{send:{},recv:{}},video:{send:{},recv:{}},candidates:{}},nomore:function(){nomore=!0}},getStatsParser={checkIfOfferer:function(result){"googLibjingleSession"===result.type&&(getStatsResult.isOfferer=result.googInitiator)}},peer=this;if(arguments[0]instanceof RTCPeerConnection){if(peer=arguments[0],navigator.mozGetUserMedia&&(mediaStreamTrack=arguments[1],callback=arguments[2],interval=arguments[3]),!(mediaStreamTrack instanceof MediaStreamTrack)&&navigator.mozGetUserMedia)throw"2nd argument is not instance of MediaStreamTrack."}else if(!(mediaStreamTrack instanceof MediaStreamTrack)&&navigator.mozGetUserMedia)throw"1st argument is not instance of MediaStreamTrack.";var nomore=!1;getStatsParser.datachannel=function(result){"datachannel"===result.type&&(getStatsResult.datachannel={state:result.state})},getStatsParser.googCertificate=function(result){"googCertificate"==result.type&&(getStatsResult.encryption=result.googFingerprintAlgorithm)},getStatsParser.checkAudioTracks=function(result){if("opus"===result.googCodecName){var sendrecvType=result.id.split("_").pop();if(result.bytesSent){var kilobytes=0;if(result.bytesSent){getStatsResult.internal.audio[sendrecvType].prevBytesSent||(getStatsResult.internal.audio[sendrecvType].prevBytesSent=result.bytesSent);var bytes=result.bytesSent-getStatsResult.internal.audio[sendrecvType].prevBytesSent;getStatsResult.internal.audio[sendrecvType].prevBytesSent=result.bytesSent,kilobytes=bytes/1024}getStatsResult.audio[sendrecvType].availableBandwidth=kilobytes.toFixed(1)}if(result.bytesReceived){var kilobytes=0;if(result.bytesReceived){getStatsResult.internal.audio[sendrecvType].prevBytesReceived||(getStatsResult.internal.audio[sendrecvType].prevBytesReceived=result.bytesReceived);var bytes=result.bytesReceived-getStatsResult.internal.audio[sendrecvType].prevBytesReceived;getStatsResult.internal.audio[sendrecvType].prevBytesReceived=result.bytesReceived,kilobytes=bytes/1024}getStatsResult.audio[sendrecvType].availableBandwidth=kilobytes.toFixed(1)}getStatsResult.audio[sendrecvType].tracks.indexOf(result.googTrackId)===-1&&getStatsResult.audio[sendrecvType].tracks.push(result.googTrackId)}},getStatsParser.checkVideoTracks=function(result){if("VP8"===result.googCodecName||"VP9"===result.googCodecName){var sendrecvType=result.id.split("_").pop();if(result.bytesSent){var kilobytes=0;getStatsResult.internal.video[sendrecvType].prevBytesSent||(getStatsResult.internal.video[sendrecvType].prevBytesSent=result.bytesSent);var bytes=result.bytesSent-getStatsResult.internal.video[sendrecvType].prevBytesSent;getStatsResult.internal.video[sendrecvType].prevBytesSent=result.bytesSent,kilobytes=bytes/1024}if(result.bytesReceived){var kilobytes=0;getStatsResult.internal.video[sendrecvType].prevBytesReceived||(getStatsResult.internal.video[sendrecvType].prevBytesReceived=result.bytesReceived);var bytes=result.bytesReceived-getStatsResult.internal.video[sendrecvType].prevBytesReceived;getStatsResult.internal.video[sendrecvType].prevBytesReceived=result.bytesReceived,kilobytes=bytes/1024}getStatsResult.video[sendrecvType].availableBandwidth=kilobytes.toFixed(1),result.googFrameHeightReceived&&result.googFrameWidthReceived&&(getStatsResult.resolutions[sendrecvType].width=result.googFrameWidthReceived,getStatsResult.resolutions[sendrecvType].height=result.googFrameHeightReceived),result.googFrameHeightSent&&result.googFrameWidthSent&&(getStatsResult.resolutions[sendrecvType].width=result.googFrameWidthSent,getStatsResult.resolutions[sendrecvType].height=result.googFrameHeightSent),getStatsResult.video[sendrecvType].tracks.indexOf(result.googTrackId)===-1&&getStatsResult.video[sendrecvType].tracks.push(result.googTrackId)}},getStatsParser.bweforvideo=function(result){"VideoBwe"===result.type&&(getStatsResult.video.bandwidth={googActualEncBitrate:result.googActualEncBitrate,googAvailableSendBandwidth:result.googAvailableSendBandwidth,googAvailableReceiveBandwidth:result.googAvailableReceiveBandwidth,googRetransmitBitrate:result.googRetransmitBitrate,googTargetEncBitrate:result.googTargetEncBitrate,googBucketDelay:result.googBucketDelay,googTransmitBitrate:result.googTransmitBitrate})},getStatsParser.googCandidatePair=function(result){if("googCandidatePair"===result.type&&"true"==result.googActiveConnection){getStatsResult.connectionType.local.ipAddress=result.googLocalAddress,getStatsResult.connectionType.remote.ipAddress=result.googRemoteAddress,getStatsResult.connectionType.transport=result.googTransportType;var localCandidate=getStatsResult.internal.candidates[result.localCandidateId];localCandidate&&(localCandidate.networkType&&(getStatsResult.connectionType.local.networkType=localCandidate.networkType),localCandidate.transport&&(getStatsResult.connectionType.local.transport=localCandidate.transport),localCandidate.ipAddress&&(getStatsResult.connectionType.systemIpAddress=localCandidate.ipAddress));var remoteCandidate=getStatsResult.internal.candidates[result.remoteCandidateId];remoteCandidate&&(remoteCandidate.networkType&&(getStatsResult.connectionType.remote.networkType=remoteCandidate.networkType),remoteCandidate.transport&&(getStatsResult.connectionType.remote.transport=remoteCandidate.transport),remoteCandidate.ipAddress&&(getStatsResult.connectionType.systemIpAddress=remoteCandidate.ipAddress))}},getStatsParser.localcandidate=function(result){"localcandidate"===result.type&&(getStatsResult.internal.candidates[result.id]={candidateType:result.candidateType,ipAddress:result.ipAddress,portNumber:result.portNumber,networkType:result.networkType,priority:result.priority,transport:result.transport,timestamp:result.timestamp,id:result.id,type:result.type},getStatsResult.connectionType.local.candidateType=result.candidateType,getStatsResult.connectionType.local.ipAddress=result.ipAddress+":"+result.portNumber,getStatsResult.connectionType.local.networkType=getStatsResult.connectionType.local.networkType||result.networkType||systemNetworkType,getStatsResult.connectionType.local.transport=result.transport)},getStatsParser.remotecandidate=function(result){"remotecandidate"===result.type&&(getStatsResult.internal.candidates[result.id]={candidateType:result.candidateType,ipAddress:result.ipAddress,portNumber:result.portNumber,networkType:result.networkType,priority:result.priority,transport:result.transport,timestamp:result.timestamp,id:result.id,type:result.type},getStatsResult.connectionType.remote.candidateType=result.candidateType,getStatsResult.connectionType.remote.ipAddress=result.ipAddress+":"+result.portNumber,getStatsResult.connectionType.remote.networkType=getStatsResult.connectionType.remote.networkType||result.networkType||systemNetworkType,getStatsResult.connectionType.remote.transport=result.transport)},getStatsParser.dataSentReceived=function(result){var mediaType="opus"!==result.googCodecName?"video":"audio";result.bytesSent&&(getStatsResult[mediaType].bytesSent+=parseInt(result.bytesSent)),result.bytesReceived&&(getStatsResult[mediaType].bytesReceived+=parseInt(result.bytesReceived))},getStatsLooper()};