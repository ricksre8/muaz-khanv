'use strict';

// Last time updated: 2017-08-13 4:33:11 PM UTC

// _______________
// getStats v1.0.4

// Open-Sourced: https://github.com/muaz-khan/getStats

// --------------------------------------------------
// Muaz Khan     - www.MuazKhan.com
// MIT License   - www.WebRTC-Experiment.com/licence
// --------------------------------------------------

"use strict";window.getStats=function(mediaStreamTrack,callback,interval){function getStatsLooper(){getStatsWrapper(function(results){results.forEach(function(result){Object.keys(getStatsParser).forEach(function(key){"function"==typeof getStatsParser[key]&&getStatsParser[key](result)})});try{peer.iceConnectionState.search(/failed/gi)!==-1&&(nomore=!0)}catch(e){nomore=!0}nomore===!0&&(getStatsResult.datachannel&&(getStatsResult.datachannel.state="close"),getStatsResult.ended=!0),getStatsResult.results=results,callback(getStatsResult),nomore||void 0!=typeof interval&&interval&&setTimeout(getStatsLooper,interval||1e3)})}function getStatsWrapper(cb){"undefined"!=typeof window.InstallTrigger?peer.getStats(mediaStreamTrack,function(res){var items=[];res.forEach(function(r){items.push(r)}),cb(items)},cb):peer.getStats(function(res){var items=[];res.result().forEach(function(res){var item={};res.names().forEach(function(name){item[name]=res.stat(name)}),item.id=res.id,item.type=res.type,item.timestamp=res.timestamp,items.push(item)}),cb(items)})}var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;"undefined"==typeof MediaStreamTrack&&(MediaStreamTrack={});var systemNetworkType=((navigator.connection||{}).type||"unknown").toString().toLowerCase(),getStatsResult={encryption:"sha-256",audio:{send:{tracks:[],codecs:[],availableBandwidth:0,streams:0},recv:{tracks:[],codecs:[],availableBandwidth:0,streams:0},bytesSent:0,bytesReceived:0},video:{send:{tracks:[],codecs:[],availableBandwidth:0,streams:0},recv:{tracks:[],codecs:[],availableBandwidth:0,streams:0},bytesSent:0,bytesReceived:0},results:{},connectionType:{systemNetworkType:systemNetworkType,systemIpAddress:"192.168.1.2",local:{candidateType:[],transport:[],ipAddress:[],networkType:[]},remote:{candidateType:[],transport:[],ipAddress:[],networkType:[]}},resolutions:{send:{width:0,height:0},recv:{width:0,height:0}},internal:{audio:{send:{},recv:{}},video:{send:{},recv:{}},candidates:{}},nomore:function(){nomore=!0}},getStatsParser={checkIfOfferer:function(result){"googLibjingleSession"===result.type&&(getStatsResult.isOfferer=result.googInitiator)}},peer=this;if(arguments[0]instanceof RTCPeerConnection){if(peer=arguments[0],navigator.mozGetUserMedia&&(mediaStreamTrack=arguments[1],callback=arguments[2],interval=arguments[3]),!(mediaStreamTrack instanceof MediaStreamTrack)&&navigator.mozGetUserMedia)throw"2nd argument is not instance of MediaStreamTrack."}else if(!(mediaStreamTrack instanceof MediaStreamTrack)&&navigator.mozGetUserMedia)throw"1st argument is not instance of MediaStreamTrack.";var nomore=!1;getStatsParser.datachannel=function(result){"datachannel"===result.type&&(getStatsResult.datachannel={state:result.state})},getStatsParser.googCertificate=function(result){"googCertificate"==result.type&&(getStatsResult.encryption=result.googFingerprintAlgorithm)};var AUDIO_codecs=["opus","isac","ilbc"];getStatsParser.checkAudioTracks=function(result){if(result.googCodecName&&"audio"===result.mediaType&&AUDIO_codecs.indexOf(result.googCodecName.toLowerCase())!==-1){var sendrecvType=result.id.split("_").pop();if(getStatsResult.audio[sendrecvType].codecs.indexOf(result.googCodecName)===-1&&getStatsResult.audio[sendrecvType].codecs.push(result.googCodecName),result.bytesSent){var kilobytes=0;if(result.bytesSent){getStatsResult.internal.audio[sendrecvType].prevBytesSent||(getStatsResult.internal.audio[sendrecvType].prevBytesSent=result.bytesSent);var bytes=result.bytesSent-getStatsResult.internal.audio[sendrecvType].prevBytesSent;getStatsResult.internal.audio[sendrecvType].prevBytesSent=result.bytesSent,kilobytes=bytes/1024}getStatsResult.audio[sendrecvType].availableBandwidth=kilobytes.toFixed(1)}if(result.bytesReceived){var kilobytes=0;if(result.bytesReceived){getStatsResult.internal.audio[sendrecvType].prevBytesReceived||(getStatsResult.internal.audio[sendrecvType].prevBytesReceived=result.bytesReceived);var bytes=result.bytesReceived-getStatsResult.internal.audio[sendrecvType].prevBytesReceived;getStatsResult.internal.audio[sendrecvType].prevBytesReceived=result.bytesReceived,kilobytes=bytes/1024}getStatsResult.audio[sendrecvType].availableBandwidth=kilobytes.toFixed(1)}getStatsResult.audio[sendrecvType].tracks.indexOf(result.googTrackId)===-1&&getStatsResult.audio[sendrecvType].tracks.push(result.googTrackId)}};var VIDEO_codecs=["vp9","vp8","h264"];getStatsParser.checkVideoTracks=function(result){if(result.googCodecName&&"video"===result.mediaType&&VIDEO_codecs.indexOf(result.googCodecName.toLowerCase())!==-1){var sendrecvType=result.id.split("_").pop();if(getStatsResult.video[sendrecvType].codecs.indexOf(result.googCodecName)===-1&&getStatsResult.video[sendrecvType].codecs.push(result.googCodecName),result.bytesSent){var kilobytes=0;getStatsResult.internal.video[sendrecvType].prevBytesSent||(getStatsResult.internal.video[sendrecvType].prevBytesSent=result.bytesSent);var bytes=result.bytesSent-getStatsResult.internal.video[sendrecvType].prevBytesSent;getStatsResult.internal.video[sendrecvType].prevBytesSent=result.bytesSent,kilobytes=bytes/1024}if(result.bytesReceived){var kilobytes=0;getStatsResult.internal.video[sendrecvType].prevBytesReceived||(getStatsResult.internal.video[sendrecvType].prevBytesReceived=result.bytesReceived);var bytes=result.bytesReceived-getStatsResult.internal.video[sendrecvType].prevBytesReceived;getStatsResult.internal.video[sendrecvType].prevBytesReceived=result.bytesReceived,kilobytes=bytes/1024}getStatsResult.video[sendrecvType].availableBandwidth=kilobytes.toFixed(1),result.googFrameHeightReceived&&result.googFrameWidthReceived&&(getStatsResult.resolutions[sendrecvType].width=result.googFrameWidthReceived,getStatsResult.resolutions[sendrecvType].height=result.googFrameHeightReceived),result.googFrameHeightSent&&result.googFrameWidthSent&&(getStatsResult.resolutions[sendrecvType].width=result.googFrameWidthSent,getStatsResult.resolutions[sendrecvType].height=result.googFrameHeightSent),getStatsResult.video[sendrecvType].tracks.indexOf(result.googTrackId)===-1&&getStatsResult.video[sendrecvType].tracks.push(result.googTrackId)}},getStatsParser.bweforvideo=function(result){"VideoBwe"===result.type&&(getStatsResult.video.bandwidth={googActualEncBitrate:result.googActualEncBitrate,googAvailableSendBandwidth:result.googAvailableSendBandwidth,googAvailableReceiveBandwidth:result.googAvailableReceiveBandwidth,googRetransmitBitrate:result.googRetransmitBitrate,googTargetEncBitrate:result.googTargetEncBitrate,googBucketDelay:result.googBucketDelay,googTransmitBitrate:result.googTransmitBitrate})},getStatsParser.googCandidatePair=function(result){if("googCandidatePair"===result.type&&"true"==result.googActiveConnection){getStatsResult.connectionType.local.ipAddress=result.googLocalAddress,getStatsResult.connectionType.remote.ipAddress=result.googRemoteAddress,getStatsResult.connectionType.transport=result.googTransportType;var localCandidate=getStatsResult.internal.candidates[result.localCandidateId];localCandidate&&localCandidate.ipAddress&&(getStatsResult.connectionType.systemIpAddress=localCandidate.ipAddress);var remoteCandidate=getStatsResult.internal.candidates[result.remoteCandidateId];remoteCandidate&&remoteCandidate.ipAddress&&(getStatsResult.connectionType.systemIpAddress=remoteCandidate.ipAddress)}};var LOCAL_candidateType=[],LOCAL_transport=[],LOCAL_ipAddress=[],LOCAL_networkType=[];getStatsParser.localcandidate=function(result){"localcandidate"===result.type&&(result.candidateType&&LOCAL_candidateType.indexOf(result.candidateType)===-1&&LOCAL_candidateType.push(result.candidateType),result.transport&&LOCAL_transport.indexOf(result.transport)===-1&&LOCAL_transport.push(result.transport),result.ipAddress&&LOCAL_ipAddress.indexOf(result.ipAddress+":"+result.portNumber)===-1&&LOCAL_ipAddress.push(result.ipAddress+":"+result.portNumber),result.networkType&&LOCAL_networkType.indexOf(result.networkType)===-1&&LOCAL_networkType.push(result.networkType),getStatsResult.internal.candidates[result.id]={candidateType:LOCAL_candidateType,ipAddress:LOCAL_ipAddress,portNumber:result.portNumber,networkType:LOCAL_networkType,priority:result.priority,transport:LOCAL_transport,timestamp:result.timestamp,id:result.id,type:result.type},getStatsResult.connectionType.local.candidateType=LOCAL_candidateType,getStatsResult.connectionType.local.ipAddress=LOCAL_ipAddress,getStatsResult.connectionType.local.networkType=LOCAL_networkType,getStatsResult.connectionType.local.transport=LOCAL_transport)};var REMOTE_candidateType=[],REMOTE_transport=[],REMOTE_ipAddress=[],REMOTE_networkType=[];getStatsParser.remotecandidate=function(result){"remotecandidate"===result.type&&(result.candidateType&&REMOTE_candidateType.indexOf(result.candidateType)===-1&&REMOTE_candidateType.push(result.candidateType),result.transport&&REMOTE_transport.indexOf(result.transport)===-1&&REMOTE_transport.push(result.transport),result.ipAddress&&REMOTE_ipAddress.indexOf(result.ipAddress+":"+result.portNumber)===-1&&REMOTE_ipAddress.push(result.ipAddress+":"+result.portNumber),result.networkType&&REMOTE_networkType.indexOf(result.networkType)===-1&&REMOTE_networkType.push(result.networkType),getStatsResult.internal.candidates[result.id]={candidateType:REMOTE_candidateType,ipAddress:REMOTE_ipAddress,portNumber:result.portNumber,networkType:REMOTE_networkType,priority:result.priority,transport:REMOTE_transport,timestamp:result.timestamp,id:result.id,type:result.type},getStatsResult.connectionType.remote.candidateType=REMOTE_candidateType,getStatsResult.connectionType.remote.ipAddress=REMOTE_ipAddress,getStatsResult.connectionType.remote.networkType=REMOTE_networkType,getStatsResult.connectionType.remote.transport=REMOTE_transport)},getStatsParser.dataSentReceived=function(result){!result.googCodecName||"video"!==result.mediaType&&"audio"!==result.mediaType||(result.bytesSent&&(getStatsResult[result.mediaType].bytesSent=parseInt(result.bytesSent)),result.bytesReceived&&(getStatsResult[result.mediaType].bytesReceived=parseInt(result.bytesReceived)))};var SSRC={audio:{send:[],recv:[]},video:{send:[],recv:[]}};getStatsParser.ssrc=function(result){if(result.googCodecName&&("video"===result.mediaType||"audio"===result.mediaType)&&"ssrc"===result.type){var sendrecvType=result.id.split("_").pop();SSRC[result.mediaType][sendrecvType].indexOf(result.ssrc)===-1&&SSRC[result.mediaType][sendrecvType].push(result.ssrc),getStatsResult[result.mediaType][sendrecvType].streams=SSRC[result.mediaType][sendrecvType].length}},getStatsLooper()};